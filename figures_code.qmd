---
title: "Figures Code"
format: html
theme: cosmo
page-layout: full
smooth-scroll: true
engine: knitr
knitr:
  opts_chunk: 
    R.options:
      width: 120
---

```{css, echo=FALSE}
.subtitle{
  text-align: left;
  margin: 1.25rem 0 0.75rem;
  font-family: var(--bs-font-sans-serif); 
  font-weight: 500;                
  line-height: 1.0;
  font-size: 1.5rem;                       
  color: navy;        
}

```

```{r}
#| include: false
# Load libraries used across figures
library(immunogenetr)
library(tidyverse)
```

::: {.subtitle}
Figure 1
:::

```{r}
# Build a table for Fig. 1.
(HLA_typing_figure_1 <- HLA_typing_1
  # Select the columns for HLA-A, B, DRB1 and DRB3/5/5
  %>% select(patient, A1:A2, B1:B2, DRB1_1:DRB1_2, DRB345_1:DRB345_2)
  # Rename the columns to resemble a clinical LIS
  %>% rename_with(~ str_replace(., "^", "m"), .cols = A1:DRB345_2)
  %>% rename_with(~ str_replace(., "_", ""), .cols = mA1:mDRB345_2)
  %>% rename_with(~ str_replace(., "$", "Cd"), .cols = mA1:mDRB3452)
  # Add a blank value to show how the function handles this entry
  %>% mutate(mA2Cd = if_else(mA2Cd == "A*11:05", "blank", mA2Cd))
  # Remove locus designations
  %>% mutate(across(mA1Cd:mDRB12Cd, ~ str_replace(., "[:alnum:]+\\*", "")))
  %>% mutate(across(mDRB3451Cd:mDRB3452Cd, ~ str_replace(., "DRB", "")))
  # Keep the first three rows
  %>% slice(1:3)
)

# Use `HLA_columns_to_GLstring` to build GL strings from the table.
(GL_strings_figure_1 <- HLA_typing_figure_1
  %>% mutate(
    GL_string = HLA_columns_to_GLstring(
      .,
      HLA_typing_columns = mA1Cd:mDRB3452Cd,
      prefix_to_remove = "m",
      suffix_to_remove = "Cd"
    )
  )
  %>% select(patient, GL_string)
)
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    

::: {.subtitle}
Figure 2
:::

```{r}
# Make an example GL string
(string <- "HLA-A*02:01+HLA-A*68:01/HLA-A*68:06^HLA-B*07:02+HLA-B*15:01|HLA-B*07:03+HLA-B*15:17")
# Use `GLstring_to_ambiguity_table` to turn the GL string into an ambiguity table.
(ambiguity_table <- string %>% GLstring_to_ambiguity_table())
# Filter the ambiguity table for the HLA-A locus.
(filtered_ambiguity_table <- ambiguity_table %>% filter(str_detect(value, "HLA-A")))
# Use `ambiguity_table_to_GLstring` to turn the filtered table back into a GL string.
(filtered_string <- filtered_ambiguity_table %>% ambiguity_table_to_GLstring())
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    
  
::: {.subtitle}
Figure 3
:::

```{r}
# Prepare an example table
(Fig_3_table <- HLA_typing_LIS
  # Change some values to show how the function handles specific inputs
  %>% mutate(mA1Cd.recipient = if_else(mA1Cd.recipient == "24:02", "24:02novel", mA1Cd.recipient))
  %>% mutate(mA2Cd.recipient = if_else(mA2Cd.recipient == "74:01", "74:01N", mA2Cd.recipient))
  %>% mutate(mA2Cd.recipient = if_else(mA2Cd.recipient == "32:01", "32:XX", mA2Cd.recipient))
  %>% mutate(mB2Cd.recipient = if_else(mB2Cd.recipient == "", "blank", mB2Cd.recipient))
  # Keep the first 3 rows
  %>% slice(1:3)
  # Keep the HLA-A, B and C columns
  %>% select(mA1Cd.recipient:mC2Cd.recipient)
)

# Run HLA_validate on the table
Fig_3_table %>%
  mutate(
    across(
      mA1Cd.recipient:mC2Cd.recipient,
      HLA_validate
    )
  )
```


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   

::: {.subtitle}
Figure 4
:::

```{r}
# Create an example GL string.
(GL_string <- "HLA-DQA1*03:03:01/HLA-DQA1*03:03:02/HLA-DQA1*03:03:03")

# Use `HLA_truncate` to reduce to 2 fields, using the default `remove_duplicates = FALSE` argument.
GL_string %>% HLA_truncate(fields = 2)

# Using `remove_duplicates = TRUE` the truncated GL string is simplified.
GL_string %>% HLA_truncate(fields = 2, remove_duplicates = TRUE)
```
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    

::: {.subtitle}
Supplemental table 1 links
:::

[R language](https://www.r-project.org)

[cli package](https://cran.r-project.org/web/packages/cli/index.html)

[dplyr package](https://cran.r-project.org/web/packages/dplyr/index.html)

[glue package](https://cran.r-project.org/web/packages/glue/index.html)

[magrittr package](https://cran.r-project.org/web/packages/magrittr/index.html)

[purrr package](https://cran.r-project.org/web/packages/purrr/index.html)

[rlang package](https://cran.r-project.org/web/packages/rlang/index.html)

[stringr package](https://cran.r-project.org/web/packages/stringr/index.html)

[tibble package](https://cran.r-project.org/web/packages/tibble/index.html)

[tidyr package](https://cran.r-project.org/web/packages/tidyr/index.html)

[tidyselect package](https://cran.r-project.org/web/packages/tidyselect/index.html)

[xml2 package](https://cran.r-project.org/web/packages/xml2/index.html)

[testthat package](https://cran.r-project.org/web/packages/testthat/index.html)
